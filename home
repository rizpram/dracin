import React, { useState, useEffect, useRef, Component } from 'react';
import { Play, ChevronLeft, Search, Info, Grid, X, Heart, Share2, Crown, Zap, MessageCircle, Send, Sparkles, Loader2, MonitorPlay, AlertTriangle, RefreshCcw } from 'lucide-react';

/**
 * =================================================================================
 * KONFIGURASI API
 * =================================================================================
 * CATATAN PENTING UNTUK PRODUCTION/GITHUB:
 * 1. Buat file .env di root project
 * 2. Isi .env dengan: VITE_API_TOKEN=token_kamu_disini
 * 3. Uncomment baris 'import.meta.env...' di bawah dan hapus token hardcoded saat deploy.
 */

const API_BASE = "https://sapimu.au";

// --- GANTI BAGIAN INI SAAT DEPLOY KE PRODUCTION ---
// const API_TOKEN = import.meta.env.VITE_API_TOKEN; // Gunakan ini untuk Production
const API_TOKEN = "dcd4d71fc48977fafc010cd4b5f123ef7b87c0b107567873df79a103d43a8218"; // Hardcoded untuk Dev/Preview

// const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_KEY; // Gunakan ini untuk Production
const GEMINI_API_KEY = ""; // Kosongkan untuk Dev jika tidak ada key

// --- PROVIDER LIST ---
const PROVIDERS = [
  "Dramabox",
  "Melolo",
  "StarShort",
  "NetShort",
  "FreeShort",
  "ShortMax",
  "DramaDash",
  "HiShort",
  "Dramawave"
];

// --- ERROR BOUNDARY ---
class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error("Uncaught error:", error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-slate-950 text-white flex flex-col items-center justify-center p-6 text-center">
          <AlertTriangle size={48} className="text-red-500 mb-4" />
          <h1 className="text-2xl font-bold mb-2">Terjadi Kesalahan</h1>
          <p className="text-slate-400 mb-6">Aplikasi mengalami kendala teknis. Silakan muat ulang.</p>
          <button 
            onClick={() => window.location.reload()} 
            className="px-6 py-2 bg-red-600 rounded-full font-bold hover:bg-red-700 transition-colors flex items-center gap-2"
          >
            <RefreshCcw size={18} /> Muat Ulang
          </button>
        </div>
      );
    }
    return this.props.children;
  }
}

// --- HELPER FUNCTIONS ---
const fetchFromApi = async (endpoint, options = {}) => {
  try {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: options.method || 'GET',
      headers: {
        'Authorization': `Bearer ${API_TOKEN}`, 
        'Content-Type': 'application/json',
        ...options.headers
      },
      body: options.body ? JSON.stringify(options.body) : undefined
    });
    
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    return data;
  } catch (error) {
    console.error(`API Error [${endpoint}]:`, error);
    return null;
  }
};

const callGeminiAPI = async (prompt) => {
  if (!GEMINI_API_KEY) return "Fitur AI belum dikonfigurasi.";
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
      }
    );
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, AI sedang sibuk.";
  } catch (error) {
    return "Terjadi kesalahan koneksi AI.";
  }
};

// --- MOCK DATA ---
const MOCK_DRAMAS = [
  {
    id: 1,
    title: "Server Sedang Sibuk",
    provider: "System",
    cover: "https://placehold.co/300x450/1e293b/FFF?text=Maintenance",
    desc: "Gagal memuat data dari server. Silakan coba lagi nanti.",
    episodes: 0,
    tags: ["System", "Offline"],
    rating: 0,
    ai_character: { name: "System", personality: "Robot", avatar: "ðŸ¤–" }
  }
];

// --- SUB-COMPONENTS ---

const AdPlaceholder = ({ type = "banner", label = "Iklan Google Ads" }) => {
  const sizeClasses = type === "banner" ? "h-20 w-full" : "h-full w-full aspect-[2/3]";
  const isNative = type === "native";
  return (
    <div className={`bg-slate-900 border border-slate-700 border-dashed rounded-lg flex flex-col items-center justify-center relative overflow-hidden group hover:bg-slate-800 transition-colors ${isNative ? 'aspect-[2/3]' : sizeClasses} ${type === 'banner' ? 'my-4' : ''}`}>
      <div className="absolute top-1 right-1 bg-gray-200 text-gray-800 text-[9px] px-1 rounded opacity-70">Ad</div>
      <MonitorPlay className="text-slate-600 mb-2" size={isNative ? 32 : 24} />
      <p className="text-slate-500 text-xs font-mono text-center px-2">{label}</p>
    </div>
  );
};

const AIChatOverlay = ({ drama, onClose }) => {
  const [messages, setMessages] = useState([
    { role: 'ai', text: `Halo, saya karakter AI dari "${drama.title}". Ada yang bisa saya bantu?` }
  ]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [messages]);

  const handleSend = async () => {
    if (!input.trim()) return;
    const userMsg = input;
    setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
    setInput("");
    setIsLoading(true);

    const charName = drama.ai_character?.name || "Tokoh Utama";
    const charPersonality = drama.ai_character?.personality || "Misterius";
    
    const prompt = `Berperanlah sebagai ${charName} dari drama "${drama.title}". Kepribadian: ${charPersonality}. User bilang: "${userMsg}". Jawab singkat (maks 2 kalimat) dalam bahasa Indonesia gaul/drama.`;
    
    const aiResponse = await callGeminiAPI(prompt);
    setMessages(prev => [...prev, { role: 'ai', text: aiResponse }]);
    setIsLoading(false);
  };

  return (
    <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center animate-in fade-in duration-200">
      <div className="bg-slate-900 w-full max-w-md h-[80vh] sm:h-[600px] sm:rounded-2xl flex flex-col shadow-2xl overflow-hidden border border-slate-700 slide-in-from-bottom duration-300">
        <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-xl">
              {drama.ai_character?.avatar || "ðŸŽ­"}
            </div>
            <div>
              <h3 className="font-bold text-white text-sm">{drama.ai_character?.name || "AI Character"}</h3>
              <p className="text-xs text-indigo-400 flex items-center gap-1"><Sparkles size={10} /> Online</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 text-slate-400 hover:text-white"><X size={20} /></button>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950/50" ref={scrollRef}>
          {messages.map((msg, idx) => (
            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-[80%] rounded-2xl px-4 py-3 text-sm ${msg.role === 'user' ? 'bg-red-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-200 rounded-bl-none border border-slate-700'}`}>
                {msg.text}
              </div>
            </div>
          ))}
          {isLoading && <Loader2 size={16} className="animate-spin text-indigo-400 ml-4" />}
        </div>
        <div className="p-4 bg-slate-800 border-t border-slate-700 flex gap-2">
          <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="Kirim pesan..." className="flex-1 bg-slate-900 border border-slate-700 text-white text-sm rounded-xl px-4 focus:outline-none focus:border-indigo-500" />
          <button onClick={handleSend} disabled={isLoading || !input.trim()} className="p-3 bg-indigo-600 rounded-xl text-white disabled:opacity-50"><Send size={18} /></button>
        </div>
      </div>
    </div>
  );
};

const VideoPlayer = ({ drama, episodeData, onNext, onPrev, onClose }) => {
  const videoRef = useRef(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [showControls, setShowControls] = useState(true);
  const [videoUrl, setVideoUrl] = useState(null);
  const [isLoadingVideo, setIsLoadingVideo] = useState(true);
  const [hasError, setHasError] = useState(false);
  
  const FALLBACK_VIDEO = "https://assets.mixkit.co/videos/preview/mixkit-girl-in-neon-sign-1232-large.mp4";

  useEffect(() => {
    let isMounted = true;
    const loadVideo = async () => {
      setIsLoadingVideo(true);
      setHasError(false);
      setVideoUrl(null);
      
      try {
        let streamUrl = null;

        if (drama.provider === 'Dramabox') {
           const chapterIndex = (episodeData?.index || 1) - 1; 
           const bookId = drama.id;
           const data = await fetchFromApi(`/dramabox/api/watch/${bookId}/${chapterIndex}?lang=in&source=search_result`);
           streamUrl = data?.data?.playUrl || data?.data?.url || data?.data?.play_url; 
        } else if (drama.provider === 'Melolo') {
           if (episodeData && episodeData.video_id) {
             const data = await fetchFromApi(`/melolo/video?video_id=${episodeData.video_id}`);
             streamUrl = data?.data?.url || data?.url || data?.data?.play_url; 
           }
        } else if (drama.provider === 'StarShort') {
           const epIndex = episodeData?.index || 1;
           const data = await fetchFromApi(`/starshort/api/v1/dramas/${drama.id}/episodes/${epIndex}?lang=3`);
           streamUrl = data?.data?.url || data?.url || data?.data?.playUrl || data?.playUrl;
        }

        if (isMounted) {
          if (streamUrl) {
            setVideoUrl(streamUrl);
          } else {
            console.warn(`Stream URL not found for provider ${drama.provider}, using fallback.`);
            setVideoUrl(FALLBACK_VIDEO);
          }
        }
      } catch (err) {
        console.error("Error fetching video:", err);
        if (isMounted) setVideoUrl(FALLBACK_VIDEO);
      }
      if (isMounted) setIsLoadingVideo(false);
    };

    loadVideo();
    return () => { isMounted = false; };
  }, [episodeData, drama]);

  const togglePlay = async () => {
    if (videoRef.current) {
      try {
        if (isPlaying) videoRef.current.pause();
        else await videoRef.current.play();
        setIsPlaying(!isPlaying);
      } catch (err) {
        console.error("Playback error:", err);
      }
    }
  };

  const handleError = () => {
    if (videoUrl !== FALLBACK_VIDEO) setVideoUrl(FALLBACK_VIDEO);
    else setHasError(true); 
  };

  return (
    <div className="fixed inset-0 z-50 bg-black flex items-center justify-center animate-in fade-in duration-300">
      <div className="relative w-full h-full max-w-md mx-auto bg-black aspect-[9/16] overflow-hidden shadow-2xl">
        {isLoadingVideo && (
           <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-900 text-white">
             <Loader2 size={40} className="animate-spin text-red-600 mb-2" />
             <p className="text-xs text-slate-400">Memuat Video...</p>
           </div>
        )}

        {hasError ? (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white z-0">
             <AlertTriangle size={48} className="text-yellow-500 mb-4" />
             <p className="text-center px-4">Maaf, video tidak tersedia atau format tidak didukung.</p>
             <button onClick={onNext} className="mt-4 px-4 py-2 bg-slate-700 rounded-full text-sm">Coba Episode Berikutnya</button>
          </div>
        ) : (
          videoUrl && (
            <video
              ref={videoRef}
              className="absolute inset-0 w-full h-full object-cover"
              src={videoUrl}
              poster={drama.cover}
              loop
              playsInline
              autoPlay
              onError={handleError}
              onClick={() => setShowControls(!showControls)}
              onPlay={() => setIsPlaying(true)}
              onPause={() => setIsPlaying(false)}
            />
          )
        )}
        
        <div className={`absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/80 transition-opacity duration-300 ${showControls ? 'opacity-100' : 'opacity-0'}`}>
          <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center pt-8">
            <button onClick={onClose} className="p-2 bg-white/20 backdrop-blur-md rounded-full text-white hover:bg-white/30">
              <ChevronLeft size={24} />
            </button>
            <div className="flex gap-3">
              <button className="p-2 text-white"><Share2 size={24} /></button>
            </div>
          </div>

          {!isPlaying && !isLoadingVideo && !hasError && (
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div className="bg-black/50 p-4 rounded-full backdrop-blur-sm">
                <Play size={48} className="text-white fill-white ml-1" />
              </div>
            </div>
          )}

          <div className="absolute bottom-0 left-0 right-0 p-6 pb-10 space-y-4">
            <div className="w-full h-12 bg-white/10 border border-white/20 backdrop-blur-sm rounded flex items-center justify-center overflow-hidden">
               <span className="text-[10px] text-white/50">Slot Iklan (320x50)</span>
            </div>

            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <span className="bg-yellow-500 text-black text-xs font-bold px-2 py-0.5 rounded flex items-center gap-1"><Crown size={12} /> PREMIUM</span>
                <span className="bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded">{drama.provider || "Drama Chindo"}</span>
              </div>
              <h2 className="text-white text-xl font-bold leading-tight drop-shadow-md line-clamp-2">{drama.title}</h2>
              <p className="text-white/80 text-sm">Episode {episodeData?.index || "?"}</p>
            </div>
            
            <div className="flex justify-between items-center gap-4">
              <button onClick={onPrev} className="flex-1 py-3 bg-white/10 backdrop-blur-md rounded-lg text-white font-medium hover:bg-white/20">Prev</button>
              <button onClick={togglePlay} className="p-3 bg-red-600 rounded-full text-white shadow-lg shadow-red-600/50">
                {isPlaying ? <div className="w-4 h-4 bg-white rounded-sm" /> : <Play size={20} fill="white" />}
              </button>
              <button onClick={onNext} className="flex-1 py-3 bg-white text-black rounded-lg font-bold hover:bg-gray-200">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const DramaDetail = ({ drama, onBack, onPlay, onChat }) => {
  const [aiReason, setAiReason] = useState(null);
  const [loadingReason, setLoadingReason] = useState(false);
  const [realEpisodes, setRealEpisodes] = useState([]);
  const [isLoadingEp, setIsLoadingEp] = useState(false);

  useEffect(() => {
    let isMounted = true;
    const fetchEpisodes = async () => {
      const seriesId = drama.series_id || drama.book_id || drama.id;
      if (!seriesId) {
        if(isMounted) setRealEpisodes([]);
        return;
      }

      const idString = String(seriesId);
      if(isMounted) setIsLoadingEp(true);
      
      try {
        let mappedList = [];
        if (drama.provider === 'Dramabox') {
            const data = await fetchFromApi(`/dramabox/api/chapters/detail/${idString}?lang=in`);
            const list = data?.data?.chapterList || data?.data?.chapters || data?.data?.list || [];
            if (Array.isArray(list) && list.length > 0) {
              mappedList = list.map((item, idx) => ({
                index: item.chapterIndex || idx + 1,
                video_id: item.chapterId || null, 
                title: item.title || `Episode ${item.chapterIndex || idx + 1}`
              }));
            }
        } else if (drama.provider === 'Melolo' && idString.length > 5) {
          const data = await fetchFromApi(`/melolo/series?series_id=${idString}`);
          const list = data?.data?.chapter_list || data?.data?.list || data?.data || [];
          if (Array.isArray(list) && list.length > 0) {
             mappedList = list.map((item, idx) => ({
               index: item.index || idx + 1,
               video_id: item.video_id || item.id || null, 
               title: item.title || `Episode ${idx + 1}`
             }));
          }
        } else if (drama.provider === 'StarShort') {
           const data = await fetchFromApi(`/starshort/api/v1/dramas/${idString}/episodes?lang=3`);
           const list = data?.data || data || [];
           if (Array.isArray(list) && list.length > 0) {
              mappedList = list.map((item, idx) => ({
                index: item.episode || idx + 1,
                video_id: null,
                title: item.title || `Episode ${idx + 1}`
              }));
           }
        }

        if (isMounted) {
           if (mappedList.length > 0) setRealEpisodes(mappedList);
           else setRealEpisodes(Array.from({length: drama.episodes || 20}, (_,i) => ({ index: i+1, video_id: null })));
        }
      } catch (err) {
        console.error("Failed to fetch episodes", err);
        if(isMounted) setRealEpisodes(Array.from({length: 20}, (_,i) => ({ index: i+1, video_id: null })));
      }
      if(isMounted) setIsLoadingEp(false);
    };
    fetchEpisodes();
    return () => { isMounted = false; };
  }, [drama]);

  const getWhyWatch = async () => {
    setLoadingReason(true);
    const tags = drama.tags ? drama.tags.join(", ") : "Drama, Romance";
    const prompt = `Alasan singkat & clickbait kenapa harus nonton "${drama.title}" (${tags})?`;
    const reason = await callGeminiAPI(prompt);
    setAiReason(reason);
    setLoadingReason(false);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-white pb-20 animate-in slide-in-from-right duration-300">
      <div className="relative h-[50vh]">
        <img src={drama.cover} alt={drama.title} className="w-full h-full object-cover opacity-60" />
        <div className="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/40 to-transparent" />
        <button onClick={onBack} className="absolute top-6 left-4 p-2 bg-black/40 backdrop-blur-md rounded-full z-10 hover:bg-black/60 transition-colors"><ChevronLeft size={24} /></button>
        <div className="absolute bottom-0 left-0 right-0 p-6">
          <div className="flex items-center gap-2 mb-2">
             <span className="text-yellow-400 flex items-center text-sm font-bold gap-1"><Zap size={14} fill="currentColor" /> FAST SERVER</span>
             <span className="text-slate-400 text-sm">â€¢ {drama.rating || "4.5"} â˜…</span>
          </div>
          <h1 className="text-3xl font-bold mb-2 line-clamp-2">{drama.title}</h1>
          <div className="flex flex-wrap gap-2 mb-4">
            {(drama.tags || ["Drama"]).slice(0,3).map((tag, i) => (
              <span key={i} className="px-3 py-1 bg-slate-800 rounded-full text-xs text-slate-300 border border-slate-700">{tag}</span>
            ))}
          </div>
          <div className="flex gap-3 mb-3">
             <button onClick={() => onPlay(realEpisodes[0])} className="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-900/50 hover:bg-red-700 active:scale-95 transition-all"><Play size={20} fill="currentColor" /> Play Ep 1</button>
             <button onClick={onChat} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-900/50 hover:bg-indigo-700 active:scale-95 transition-all"><MessageCircle size={20} /> Chat AI</button>
          </div>
        </div>
      </div>
      <div className="px-6">
        <AdPlaceholder type="banner" label="Google Ads (Detail Banner)" />
        <div className="mb-6 p-4 bg-gradient-to-r from-indigo-900/40 to-purple-900/40 rounded-xl border border-indigo-500/30">
          <div className="flex justify-between items-start mb-2">
            <h3 className="font-bold text-indigo-300 text-sm flex items-center gap-2"><Sparkles size={14} /> AI Recommendation</h3>
            {!aiReason && <button onClick={getWhyWatch} disabled={loadingReason} className="text-xs bg-indigo-600 px-3 py-1 rounded-full hover:bg-indigo-500 transition-colors">{loadingReason ? '...' : 'âœ¨ Kenapa Nonton?'}</button>}
          </div>
          {aiReason ? <p className="text-indigo-100 text-sm italic animate-in fade-in">"{aiReason}"</p> : <p className="text-slate-500 text-xs">Tanya AI kenapa drama ini seru!</p>}
        </div>
        <h3 className="font-bold text-lg mb-2">Sinopsis</h3>
        <p className="text-slate-400 text-sm leading-relaxed mb-4">{drama.desc || drama.introduction || "Tidak ada deskripsi tersedia."}</p>
      </div>
      <div className="px-6 py-4">
        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Episode ({realEpisodes.length})</h3></div>
        {isLoadingEp ? <div className="flex justify-center py-10"><Loader2 className="animate-spin text-red-600" /></div> : (
          <div className="grid grid-cols-5 gap-3">
            {realEpisodes.slice(0, 50).map((ep, i) => (
              <button key={i} onClick={() => onPlay(ep)} className="aspect-square rounded-lg bg-slate-800 hover:bg-slate-700 flex flex-col items-center justify-center border border-slate-700 relative overflow-hidden group transition-colors">
                <span className="text-sm font-medium group-hover:text-red-500">{ep.index}</span>
                <div className="absolute top-0 right-0 p-0.5"><div className="w-2 h-2 bg-yellow-500 rounded-full shadow-[0_0_5px_rgba(234,179,8,0.8)]"></div></div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// --- MAIN APP COMPONENT ---
export default function App() {
  const [view, setView] = useState('home');
  const [selectedDrama, setSelectedDrama] = useState(null);
  const [currentEpisodeData, setCurrentEpisodeData] = useState(null);
  const [showChat, setShowChat] = useState(false);
  const [activeProvider, setActiveProvider] = useState("Dramabox"); 
  
  const [dramas, setDramas] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");

  useEffect(() => {
    if (view === 'home') document.title = "Drama Chindo - Home";
    else if (view === 'detail' && selectedDrama) document.title = `${selectedDrama.title} - Drama Chindo`;
    else if (view === 'player') document.title = "Nonton Drama - Drama Chindo";
  }, [view, selectedDrama]);

  const mapApiDataToApp = (list, providerName) => {
    return list.map(item => ({
      id: item.bookId || item.book_id || item.series_id || item.id,
      title: item.bookName || item.book_name || item.title || item.name || "No Title",
      cover: item.coverUrl || item.cover_url || item.cover || item.poster || "https://placehold.co/300x450/222/FFF?text=No+Cover",
      desc: item.introduction || item.desc || item.description || "Sinopsis belum tersedia.",
      episodes: item.chapterCount || item.total_chapter || item.episodes_count || item.total_episodes || 50,
      provider: providerName, 
      rating: (4 + Math.random()).toFixed(1),
      tags: item.tags || ["Trending", "New"],
      ai_character: { name: "Tokoh Utama", personality: "Keren", avatar: "ðŸ˜Ž" }
    }));
  };

  useEffect(() => {
    let isMounted = true;
    const fetchData = async () => {
      if(isMounted) setIsLoading(true);
      let endpoint = "";
      
      if (searchQuery.length > 2) {
         if (activeProvider === 'Dramabox') endpoint = `/dramabox/api/search/${encodeURIComponent(searchQuery)}/1?lang=in`;
         else if (activeProvider === 'Melolo') endpoint = `/melolo/search?query=${encodeURIComponent(searchQuery)}`;
         else if (activeProvider === 'StarShort') endpoint = `/starshort/api/v1/dramas/search?q=${encodeURIComponent(searchQuery)}&lang=3`;
         else {
             if (activeProvider === 'Melolo') endpoint = "/melolo/bookmall?";
             else endpoint = "/dramabox/api/foryou/1?lang=in";
         }
      } else {
         if (activeProvider === 'Melolo' || view === 'library') endpoint = "/melolo/bookmall?";
         else if (activeProvider === 'Dramabox') endpoint = "/dramabox/api/foryou/1?lang=in";
         else if (activeProvider === 'StarShort') endpoint = "/starshort/api/v1/dramas/recommended?lang=3";
         else endpoint = "/dramabox/api/foryou/1?lang=in"; 
      }

      const data = await fetchFromApi(endpoint);
      
      if (isMounted) {
        if (data && data.data && (Array.isArray(data.data.list) || Array.isArray(data.data))) {
          const list = Array.isArray(data.data.list) ? data.data.list : data.data;
          let mappedData = mapApiDataToApp(list, activeProvider);
          const providersWithSearch = ['Dramabox', 'Melolo', 'StarShort'];
          if (searchQuery.length > 2 && !providersWithSearch.includes(activeProvider)) {
              mappedData = mappedData.filter(d => d.title.toLowerCase().includes(searchQuery.toLowerCase()));
          }
          setDramas(mappedData);
        } else {
          if (view === 'home' && searchQuery === "") setDramas(MOCK_DRAMAS); 
          else setDramas([]);
        }
        setIsLoading(false);
      }
    };

    const timeoutId = setTimeout(() => { fetchData(); }, 500);
    return () => { clearTimeout(timeoutId); isMounted = false; };
  }, [view, activeProvider, searchQuery]);

  const handleDramaClick = (drama) => { setSelectedDrama(drama); setView('detail'); setShowChat(false); };
  const handlePlay = (episodeData) => { setCurrentEpisodeData(episodeData); setView('player'); };

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-slate-950 text-white font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-slate-800">
        {showChat && selectedDrama && <AIChatOverlay drama={selectedDrama} onClose={() => setShowChat(false)} />}
        {view === 'player' && selectedDrama ? (
          <VideoPlayer drama={selectedDrama} episodeData={currentEpisodeData} onNext={() => console.log("Next")} onPrev={() => console.log("Prev")} onClose={() => setView('detail')} />
        ) : view === 'detail' && selectedDrama ? (
          <DramaDetail drama={selectedDrama} onBack={() => setView('home')} onPlay={handlePlay} onChat={() => setShowChat(true)} />
        ) : (
          <div className="pb-24 animate-in fade-in duration-300">
            <div className="sticky top-0 z-30 bg-slate-950/90 backdrop-blur-md p-4 border-b border-slate-800">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-2xl font-black text-red-600 tracking-tighter cursor-pointer" onClick={() => window.location.reload()}>DRAMA <span className="text-white">CHINDO</span></h1>
                <div className="bg-yellow-500/10 border border-yellow-500/20 px-3 py-1 rounded-full"><p className="text-yellow-500 text-xs font-bold flex items-center gap-1"><Crown size={12} /> VIP ACCESS</p></div>
              </div>
              {view === 'home' && (
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={18} />
                  <input type="text" placeholder={`Cari di ${activeProvider}...`} className="w-full bg-slate-900 border border-slate-800 rounded-xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-red-600 transition-colors placeholder-slate-600" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                  {searchQuery && <button onClick={() => setSearchQuery("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white"><X size={16} /></button>}
                </div>
              )}
            </div>
            <div className="px-4"><AdPlaceholder type="banner" label="Google Ads (Home Banner)" /></div>
            {view === 'home' && (
              <div className="flex gap-3 overflow-x-auto px-4 py-2 scrollbar-hide mb-2 pb-4">
                {PROVIDERS.map((provider) => (
                  <button key={provider} onClick={() => { setActiveProvider(provider); setSearchQuery(""); }} className={`px-4 py-1.5 rounded-full text-sm whitespace-nowrap border transition-all ${activeProvider === provider ? 'bg-white text-black border-white font-bold shadow-lg shadow-white/20 scale-105' : 'bg-transparent border-slate-700 text-slate-400 hover:border-slate-500 hover:text-white'}`}>{provider}</button>
                ))}
              </div>
            )}
            <div className="px-4 min-h-[400px]">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2">{view === 'library' ? 'ðŸ“š Pustaka Lengkap' : `ðŸ”¥ Trending di ${activeProvider}`}</h2>
              {isLoading ? (
                <div className="grid grid-cols-2 gap-4">{[1,2,3,4].map(i => <div key={i} className="aspect-[2/3] bg-slate-900 rounded-xl animate-pulse"></div>)}</div>
              ) : (
                <div className="grid grid-cols-2 gap-4">
                  {dramas.map((drama, index) => (
                    <React.Fragment key={`${drama.id}-${index}`}>
                      <div onClick={() => handleDramaClick(drama)} className="group relative aspect-[2/3] rounded-xl overflow-hidden cursor-pointer bg-slate-900 hover:scale-[1.02] transition-transform duration-200">
                        <img src={drama.cover} alt={drama.title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90" />
                        <div className="absolute top-2 right-2"><span className="bg-red-600 text-[10px] font-bold px-2 py-0.5 rounded text-white shadow-sm">FULL</span></div>
                        <div className="absolute bottom-0 left-0 right-0 p-3">
                          <p className="text-yellow-400 text-[10px] font-bold mb-1">{drama.provider}</p>
                          <h3 className="text-sm font-bold leading-tight mb-1 line-clamp-2">{drama.title}</h3>
                          <div className="flex justify-between items-center"><p className="text-xs text-slate-400">{drama.episodes} Ep</p><Sparkles size={12} className="text-indigo-400" /></div>
                        </div>
                      </div>
                      {index === 1 && view === 'home' && <AdPlaceholder type="native" label="Native Ad (In-Feed)" />}
                    </React.Fragment>
                  ))}
                </div>
              )}
              {!isLoading && dramas.length === 0 && (
                <div className="text-center py-20 text-slate-500 flex flex-col items-center">
                  <Info size={40} className="mb-2 opacity-50"/>
                  <p>Tidak ada drama ditemukan untuk {activeProvider}.</p>
                  {searchQuery && <p className="text-xs mt-1">Coba kata kunci lain.</p>}
                </div>
              )}
            </div>
          </div>
        )}
        {(view === 'home' || view === 'library') && (
          <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-950/90 backdrop-blur-lg border-t border-slate-800 flex justify-around py-3 px-2 z-40">
            <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'home' ? 'text-red-600' : 'text-slate-500 hover:text-white'}`}><Grid size={20} /><span className="text-[10px] font-medium">Home</span></button>
            <button className="flex flex-col items-center gap-1 text-slate-500 hover:text-white cursor-not-allowed opacity-50"><Search size={20} /><span className="text-[10px] font-medium">Browse</span></button>
            <button onClick={() => setView('library')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'library' ? 'text-red-600' : 'text-slate-500 hover:text-white'}`}><Heart size={20} /><span className="text-[10px] font-medium">Library</span></button>
          </div>
        )}
      </div>
    </ErrorBoundary>
  );
}
